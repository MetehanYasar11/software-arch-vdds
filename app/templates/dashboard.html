{% extends 'base.html' %}
{% block content %}
<div class="dark-card">
  <h2>Manager Dashboard</h2>
  <div class="row">
  <div class="col-md-4">
    <ul class="list-group mb-3">
      <li class="list-group-item">Total Inspections: {{ total }}</li>
      <li class="list-group-item">False Alarm Rate: {{ (false_alarms/total*100) if total else 0 | round(1) }}%</li>
      <li class="list-group-item">Missed Defect Rate: {{ (missed/total*100) if total else 0 | round(1) }}%</li>
    </ul>
  </div>
  <div class="col-md-4">
    <canvas id="pieChart"></canvas>
  </div>
  <div class="col-md-4">
    <canvas id="barChart"></canvas>
  </div>
  </div>
  <!-- Export CSV button (manager only) -->
  <div class="mb-3">
    <a href="{{ url_for('main.export_csv') }}" class="btn btn-primary">Export CSV</a>
  </div>

  <!-- Last 10 Inspections Table -->
  <div class="table-responsive">
    <table class="table table-sm table-bordered bg-dark text-light">
      <thead>
        <tr>
          <th>ID</th>
          <th>User</th>
          <th>Result</th>
          <th>Disposition</th>
        </tr>
      </thead>
      <tbody>
        {% for log in last_logs %}
        <tr>
          <td>{{ log.id }}</td>
          <td>{{ log.user.username if log.user else 'N/A' }}</td>
          <td>{{ log.result }}</td>
          <td>{{ log.disposition }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  <script>
  var pieCtx = document.getElementById('pieChart').getContext('2d');
  var pieChart = new Chart(pieCtx, {
    type: 'pie',
    data: {
      labels: ['Accept', 'Rework', 'Scrap'],
      datasets: [{
        data: [{{ disposition_counts['Accept'] }}, {{ disposition_counts['Rework'] }}, {{ disposition_counts['Scrap'] }}],
        backgroundColor: ['#28a745', '#ffc107', '#dc3545']
      }]
    }
  });
  var barCtx = document.getElementById('barChart').getContext('2d');
  var barChart = new Chart(barCtx, {
    type: 'bar',
    data: {
      labels: ['False Alarm', 'Missed Defect'],
      datasets: [{
        label: 'Count',
        data: [{{ false_alarms }}, {{ missed }}],
        backgroundColor: ['#007bff', '#fd7e14']
      }]
    }
  });
</script>
{% endblock %}
